name: JUnit Test Results

on:
  push:
    branches: [ main, develop ]

jobs:
  test-results:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Check if junit.xml exists in commit
      id: check-junit
      run: |
        # Get files changed/added in the latest commit
        changed_files=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git ls-files)

        # Check if any file is named exactly junit.xml and capture its path
        junit_found=false
        junit_path=""
        for file in $changed_files; do
          if [[ "$(basename "$file")" == "junit.xml" ]]; then
            junit_found=true
            junit_path="$file"
            break
          fi
        done

        if [[ "$junit_found" == "true" ]]; then
          echo "junit_in_commit=true" >> $GITHUB_OUTPUT
          echo "junit_path=$junit_path" >> $GITHUB_OUTPUT
          echo "✅ Found junit.xml in the latest commit: $junit_path"
        else
          echo "junit_in_commit=false" >> $GITHUB_OUTPUT
          echo "❌ No junit.xml found in the latest commit"
        fi

    - name: Publish Test Report
      if: steps.check-junit.outputs.junit_in_commit == 'true'
      uses: mikepenz/action-junit-report@v5
      with:
        report_paths: ${{ steps.check-junit.outputs.junit_path }}
        check_name: 'CI Pipeline Test Results'
        fail_on_failure: true
        detailed_summary: true
        include_passed: true
        annotate_only: true
